# ğŸ· Spring Boot JWT Tutorial

# 1. **JWT ì†Œê°œ, í”„ë¡œì íŠ¸ ìƒì„±**

- JWT ì¥ì : ê°„í¸í•˜ê³  ì‰½ê²Œ ì ìš© ê°€ëŠ¥ â†’ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸ ì§„í–‰ ì‹œ ìœ ìš©

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

â‡’ ì´ ë¬¸ìì—´ì„ í†µí•´ ì„œë²„ì—ì„œ í•´ë‹¹ í† í°ì´ ìœ ìš©í•œì§€ ê²€ì¦

![Untitled](./images/untitled.png)

## ì‹¤ì „

- lombok ì„¤ì •(intellij ì‚¬ìš© ì‹œ)

![Untitled](./images/untitled.png)

- HelloController.java ìƒì„±

# 2. **Security ì„¤ì •, Data ì„¤ì •**

- SecurityConfig.java ìƒì„±

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

## JWT ì„¤ì •

- application.yml ì„¤ì •
- entity íŒ¨í‚¤ì§€ ìƒì„±

### User.java

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

### Authority.java

- User entityì™€ ë™ì¼

### data.sql ìƒì„±

### h2-consoleì„ ì´ìš©í•´ ì—”í‹°í‹° ìƒì„± ì—¬ë¶€ í™•ì¸

- security ì„¤ì • ì¶”ê°€
- ë²„ê·¸: [https://github.com/abarthdew/jwt-tutorial/issues/5](https://github.com/abarthdew/jwt-tutorial/issues/5)
- ì‹¤í–‰: shellì— ì¿¼ë¦¬ë¬¸ ì¶œë ¥
    
    ```bash
    Hibernate: 
    
        drop table if exists authority CASCADE
    Hibernate:
    
        drop table if exists user CASCADE
    Hibernate:
    
        drop table if exists user_authority CASCADE
    Hibernate:
    
        create table authority (
           authority_name varchar(50) not null,
            primary key (authority_name)
        )
    Hibernate: 
    
        create table user (
           user_id bigint generated by default as identity,
            activated boolean,
            nickname varchar(50),
            password varchar(100),
            username varchar(50),
            primary key (user_id)
        )
    Hibernate: 
    
        create table user_authority (
           user_id bigint not null,
            authority_name varchar(50) not null,
            primary key (user_id, authority_name)
        )
    Hibernate:
    
        alter table user
           add constraint UK_sb8bbouer5wak8vyiiy4pf2bx unique (username)
    Hibernate:
    
        alter table user_authority
           add constraint FK6ktglpl5mjosa283rvken2py5
           foreign key (authority_name)
           references authority
    Hibernate: 
    
        alter table user_authority
           add constraint FKpqlsjpkybgos9w2svcri7j8xy
           foreign key (user_id)
           references user
    ```
    

### ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„ DB ì ‘ì†

- [localhost:8080/h2-console](http://localhost:8080/h2-console) â†’ [connect] ë²„íŠ¼ í´ë¦­í•´ì„œ ì ‘ì†
    
    ![Untitled](./images/untitled.png)
    
    ![Untitled](./images/untitled.png)
    

# 3. **JWT ì½”ë“œ, Security ì„¤ì • ì¶”ê°€**

### To Do

- JWT ì„¤ì • ì¶”ê°€
- JWT ê´€ë ¨ ì½”ë“œ ê°œë°œ
- Security ì„¤ì • ì¶”ê°€

### application.ymlì— JWT ì„¤ì • ì¶”ê°€

### build.gradleì— JWT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

### JWT ê°œë°œ - jwt íŒ¨í‚¤ì§€ ì¶”ê°€

1) TokenProvider.java

2) JwtFilter.java

3) JwtSecurityConfig.java

4) JwtAuthenticationEntryPoint.java

5) JwtAccessDeniedHandler.java

### ìœ„ 5ê°œì˜ í´ë˜ìŠ¤ë¥¼ SecurityConfig.java ì— ì ìš©

# 4. **DTO, Repository, ë¡œê·¸ì¸**

![Untitled](./images/untitled.png)

### 1) ì™¸ë¶€ì™€ì˜ í†µì‹œì— ì‚¬ìš©í•  `DTO` í´ë˜ìŠ¤ê°€ ìˆëŠ” íŒ¨í‚¤ì§€ ìƒì„±

### 2) **respository íŒ¨í‚¤ì§€** ìƒì„±

: User entityì— ë§¤í•‘ë˜ëŠ” repositoryë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´, `UserRepository` ì¸í„°í˜ì´ìŠ¤ ìƒì„±

### 3) **service**

: SpringSecurityì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ ì¤‘ í•˜ë‚˜ì¸ UserDetailsServiceë¥¼ ì»¤ìŠ¤í…€í•˜ê²Œ êµ¬í˜„í•œ `CustomUserDetailsService` í´ë˜ìŠ¤ ìƒì„±

### 4) ë¡œê·¸ì¸ api ì¶”ê°€: `AuthController`

### 5) postman í…ŒìŠ¤íŠ¸

![Untitled](./images/untitled.png)

(adminì€ data.sqlì˜ insertë¬¸ì´ ì„œë²„ê°€ ì‹œì‘ë  ë•Œ ìë™ì‹¤í–‰ë˜ì–´ dbì— ì €ì¥ëœ ìƒíƒœ)

â‡’ ê²°ê³¼: í† í° ë¦¬í„´

![Untitled](./images/untitled.png)

### (+) ìœ ìš©í•œ ê¸°ëŠ¥

![Untitled](./images/untitled.png)

# 5. **íšŒì›ê°€ì…, ê¶Œí•œê²€ì¦**

![Untitled](./images/untitled.png)

### 1) SecurityUtil íŒ¨í‚¤ì§€, í´ë˜ìŠ¤ ìƒì„±: ê°„ë‹¨í•œ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë¥¼ ë§Œë“¤ê¸° ìœ„í•¨

- SecurityContextì— getAuthentication()ì™€ ê°™ì´ Authentication ê°ì²´ê°€ ì €ì¥ë˜ëŠ” ì‹œì :
    
    ![Untitled](./images/untitled.png)
    
    ```java
    // JwtFilter.javaì˜ doFilter() ë©”ì„œë“œ
    
    // requestê°€ ë“¤ì–´ì˜¤ëŠ” ì‹œì ì— SecurityContextì— Authentication ê°ì²´ê°€ ì €ì¥ë¨
    SecurityContextHolder.getContext().setAuthentication(authentication);
    ```
    
    - ì´ë•Œ ì €ì¥ëœ ê°ì²´ê°€
    
    ```java
    // ì—¬ê¸°ì„œ êº¼ë‚´ì§€ê²Œ ë¨
    
    // SecurityUtil.javaì˜ getCurrentUsername() ë©”ì„œë“œ
    SecurityContextHolder.getContext().getAuthentication();
    ```
    

### 2) íšŒì›ê°€ì… ë¡œì§ ìƒì„±: UserService í´ë˜ìŠ¤ ìƒì„±

(1) data.sqlì˜ ê¶Œí•œì€ USER, ADMIN 

â†’ UserServiceì˜ ROLE_USER ê¶Œí•œê³¼ì˜ ì°¨ì´ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸

(2) ì˜¤ë²„ë¡œë”©ëœ ë‘ ê°€ì§€ getMyUserWithAuthorities() ë©”ì„œë“œ

â†’ í—ˆìš© ê¶Œí•œì„ ë‹¤ë¥´ê²Œ í•´ì„œ, ê¶Œí•œ ê²€ì¦ ë¶€ë¶„ í…ŒìŠ¤íŠ¸

### 3) Service ë‚´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  Controller ìƒì„±

### 4) ì„œë²„ ì‹œì‘ í›„ postman, h2-consoleë¡œ UserController íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸

(1) íšŒì›ê°€ì… ì§„í–‰

![Untitled](./images/untitled.png)

```sql
Hibernate: 
    select
        user0_.user_id as user_id1_1_0_,
        authority2_.authority_name as authorit1_0_1_,
        user0_.activated as activate2_1_0_,
        user0_.nickname as nickname3_1_0_,
        user0_.password as password4_1_0_,
        user0_.username as username5_1_0_,
        authoritie1_.user_id as user_id1_2_0__,
        authoritie1_.authority_name as authorit2_2_0__
    from
        user user0_
    left outer join
        user_authority authoritie1_
            on user0_.user_id=authoritie1_.user_id
    left outer join
        authority authority2_
            on authoritie1_.authority_name=authority2_.authority_name
    where
        user0_.username=?
Hibernate: 
    insert
    into
        user
        (user_id, activated, nickname, password, username)
    values
        (default, ?, ?, ?, ?)
Hibernate: 
    insert
    into
        user_authority
        (user_id, authority_name)
    values
        (?, ?)
```

(2) ê°€ì…ì •ë³´ h2-consoleì—ì„œ í™•ì¸

![Untitled](./images/untitled.png)

- test3 ê³„ì •ì€ USER ê¶Œí•œì„ ê°€ì§€ê³  ìˆìŒ
- admin ê³„ì •ì€ ROLE_ADMIN, ROLE_USER ê¶Œí•œ 2ê°€ì§€ë¥¼ ê°€ì§€ê³  ìˆìŒ

### 4-2) ì„œë²„ ì‹œì‘ í›„ postman, h2-consoleë¡œ UserController get[My]UserInfo() í…ŒìŠ¤íŠ¸

(1) ADMIN ê¶Œí•œë§Œ í—ˆìš©í–ˆë˜ api í…ŒìŠ¤íŠ¸

```java
@GetMapping("/admin/{username}")
@PreAuthorize("hasAnyRole('ADMIN')") // ADMIN ê¶Œí•œë§Œ í˜¸ì¶œ
public ResponseEntity<User> getAdminInfo(@PathVariable String username) {
    return ResponseEntity.ok(userService.getUserWithAuthorities(username));
}
```

- â‡’ ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ ì—ëŸ¬ë‚¨
    
    ![Untitled](./images/untitled.png)
    
- USER, ADMIN ê¶Œí•œ ëª¨ë‘ ê°€ì§„ admin ê³„ì •ìœ¼ë¡œ í† í° ë°œê¸‰
    
    ![Untitled](./images/untitled.png)
    
- Authorization íƒ­ì— í† í° ì ì¬
    
    ```java
    // Tests íƒ­
    
    var jsonData = JSON.parse(responseBody) // responseBodyì˜ jsonDateë¥¼ íŒŒì‹±
    pm.globals.set("jwt_tutorial_token", jsonData.token);
    // jsonData.token: token í•„ë“œì— ìˆëŠ” ê°’ì„
    // â€œjwt_tutorial_tokenâ€ ë³€ìˆ˜ì— ë‹´ìŒ
    ```
    
    ![Untitled](./images/untitled.png)
    
    - â†“ ì´ë ‡ê²Œ í•´ ë†“ìœ¼ë©´ ë‹¤ë¥¸ requestì—ì„œë„ í•´ë‹¹ ë³€ìˆ˜ì˜ ê°’ ì‚¬ìš© ê°€ëŠ¥
    
    ![Untitled](./images/untitled.png)
    

(2) admin ê³„ì • í† í°ìœ¼ë¡œ test1 ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°

- /api/user/test1 : `("hasAnyRole('USER')") // USER ê¶Œí•œë§Œ í˜¸ì¶œ`
- /api/admin/test1 : `("hasAnyRole('ADMIN')") // ADMIN ê¶Œí•œë§Œ í˜¸ì¶œ`
    
    â‡’ ë‘˜ ë‹¤ ë™ì¼í•œ test1 ê³„ì •ì˜ ì •ë³´ê°€ ì¶œë ¥ë¨
    

![Untitled](./images/untitled.png)

![Untitled](./images/untitled.png)

(3) admin ê³„ì • í† í°ì´ ì•„ë‹Œ test1 í† í°ì„ ë°œê¸‰ë°›ëŠ”ë‹¤ë©´?

![Untitled](./images/untitled.png)

â‡’ ìƒˆë¡œ ë°œê¸‰ëœ í† í°ì€ â€œjwt_tutorial_tokenâ€ ì „ì—­ë³€ìˆ˜ì— ë‹´ê²¨ì§€ê²Œ ë¨

- `("hasAnyRole('ADMIN')") // ADMIN ê¶Œí•œë§Œ í˜¸ì¶œ` â†’ 403 Forbidden ì˜¤ë¥˜ ë°œìƒ
    
    ![Untitled](./images/untitled.png)
    
    â‡’ test1 ê³„ì •ìœ¼ë¡œ ë°œê¸‰ë°›ì€ í† í°ì€ í•´ë‹¹ apië¥¼ í˜¸ì¶œí•˜ëŠ” ê¶Œí•œì´ ì—†ìŒ
    
    â‡’ 403 Forbidden ì˜¤ë¥˜: JwtAccessDeniedHandlerê°€ ì‘ë™
    
- /api/user/test1: `("hasAnyRole('USER')") // USER ê¶Œí•œë§Œ í˜¸ì¶œ` â†’ ì •ìƒ ì‘ë™

![Untitled](./images/untitled.png)

- /api/user: `("hasAnyRole('USER','ADMIN')") // @PreAuthorizeë¥¼ í†µí•´ USER, ADMIN ë‘ ê°€ì§€ ê¶Œí•œ ëª¨ë‘ í—ˆìš©` â†’ ì •ìƒ ì‘ë™

![Untitled](./images/untitled.png)

# ì°¸ê³ ìë£Œ

- https://github.com/SilverNine/spring-boot-jwt-tutorial
